{% extends 'base.html' %} {% load static %} 

{% load crispy_forms_tags %}

{% block title %}
    Ventas
{% endblock %}

{% block css %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'assets/css/sales.css' %}">

    <style>
        .hidden{
            display: none;
        }
    </style>
{% endblock %}

{% block content %}



<!-- Finaliza cuadro superior de la pantalla -->

<br>

<form method="POST" action=".">
    {% csrf_token %}

        {{form.customer|as_crispy_field}}
        <!-- Inicia cuadro superior de la pantalla (cliente e información extra) -->
        <div class="row mb-5">
            <div class="col-md-12">

                <!-- Inicia bloque "Información del cliente" -->
                <div  id="estilo-tabla">
                    <div class="col-md-6">
                        <h2 id="titulo-cliente">Información del cliente:</h2>
                        <dl>
                            <dt>Nombre</dt>
                            <dd id="customer-name">{{customer.name}}</dd>
                            <dt>RFC</dt>
                            <dd id="customer-rfc">{{customer.rfc}}</dd>
                            <dt>Dirección</dt>
                            <dd id="customer-address">{{customer.address}}</dd>
                            <dt>Teléfono</dt>
                            <dd id="customer-phone">{{customer.phone}}</dd>
                            <dt>Correo</dt>
                            <dd id="customer-email">{{customer.email}}</dd>
                        </dl>
                    </div>
                    <!-- Finaliza bloque "Información del cliente" -->
        
                    <!-- Inicia bloque "Otra información" -->
                    <div class="col-md-6">            
                        <h2 id="titulo-cliente">Otra información:</h2>
                        
                        <p>Método de pago:</p>
        
                        <div id="radios">
                            <input type="radio" id="efectivo" name="metodo" value="efectivo"
                                    checked>
                            <label for="efectivo">Efectivo</label>
                        </div>
                        <div id="radios">
                            <input type="radio" id="tarjeta" name="metodo" value="tarjeta"
                                    >
                            <label for="tarjeta">Tarjeta</label>
                        </div>
        
                        <p>Tipo de venta:</p>
        
                        <div id="radios">
                            <input type="radio" id="contado" name="tipo" value="contado" checked>
                            <label for="contado">Contado</label>
                        </div>
                        <div id="radios">
                            <input type="radio" id="credito" name="tipo" value="credito">
                            <label for="credito">Credito</label>
                        </div>
                    </div>
                    <!-- Finaliza bloque "Otra información" -->                
                </div>
            </div>
        </div>
    
        

        {{formset.management_form}}
        
        {% if formset %}
            <div id="product-form-list">
                {% for form_details in formset %}
                    <div class="card mt-4 mb-4 product-form">
                        {{form_details.errors}}
                    </div>
                {% endfor %}
            </div>
            <div id="empty-form" class="">

                <input type="hidden" name="form-sale" id="id_form-sale"> 
                <div id="div_id_form-product" class="mb-3"> 
                    <label for="id_form-product" class="form-label requiredField">Producto<span class="asteriskField">*</span> </label> 
                    <select name="form-product" class="cart-item-title select form-select" id="id_form-product"> 
                    </select>
                </div> 
            </div>

            <button id="add-form" type="button" class="btn btn-primary">Agregar producto</button>
        {% endif %}
            
        
        <section class="container content-section">
            <h2 class="section-header">Venta</h2>
            {% comment %} <div class="cart-row">
                <span class="cart-item cart-header cart-column">Producto</span>
                <span class="cart-price cart-header cart-column">Precio</span>
                <span class="cart-quantity cart-header cart-column">Cantidad</span>
                <span class="cart-quantity cart-header cart-column">Total del producto</span>
            </div>
            <div class="cart-items form-empty">
            </div>
            <div class="cart-total">
                <strong class="cart-total-title">Total</strong>
                {{form.total}}
            </div> {% endcomment %}

            <div class="table-responsive">
                <table id="cart-table" class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Total del producto</th>
                        </tr>
                    </thead>
                    <tbody id="cart-body">
                        
                    </tbody>
                </table>
                <tr class="cart-total">
                    <strong class="cart-total-title">Total</strong>
                    {{form.total}}
                </tr>
            </div>


        </section>

        {{form.commentaries|as_crispy_field}}

        <div class="col-md-12" style="text-align: right;margin-top: 5px;">
            <button id="submit-btn" class="btn btn-primary btn-lg save-sale" type="submit">
                Guardar
            </button>
        </div>

    </form>
{% endblock %}

{% block js %}


    <script>

    // event change select 
    $('#id_customer').on('select2:select', function (e) { 
        //var customerSelected = $('#id_customer').select2('data')
        var customerSelected = e.params.data.id;
        $.ajax({
            url: `http://localhost:8000/sales/get_customer_by_id/${customerSelected}`,
            type: 'GET',
            dataType: 'json'
        }).done(function( data2 ) {
            document.getElementById('customer-name').innerHTML = data2.name
            document.getElementById('customer-rfc').innerHTML = data2.rfc
            document.getElementById('customer-address').innerHTML = data2.address
            document.getElementById('customer-phone').innerHTML = data2.phone
            document.getElementById('customer-email').innerHTML = data2.email
        })
    });

        
    </script>
    
    <script>
        $("#id_customer").select2({
            ajax: {
                url: `http://localhost:8000/sales/get_customers_by_name`,
                type: 'GET',
                dataType: 'json',
                processResults: function (data) {
                    // Transforms the top-level key of the response object from 'items' to 'results'
                    var dataObject = JSON.parse(data)
                    return {
                        
                        results: dataObject
                    };
                }
                // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
            }
        });

        $("#id_form-product").select2({
            ajax: {
                url: `http://localhost:8000/sales/get_products_by_name`,
                type: 'GET',
                dataType: 'json',
                processResults: function (data) {
                    var dataObject = JSON.parse(data)
                    // Transforms the top-level key of the response object from 'items' to 'results'
                    return {
                        results: dataObject
                    };
                }
                // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
            }
        });
        
        
    </script>

    <script>
        function removeCartItem(event) {
            var buttonClicked = event.target
            buttonClicked.parentElement.parentElement.remove()
            updateCartTotal()
        }

        function quantityChanged(event) {
            var input = event.target
            if (isNaN(input.value) || input.value <= 0) {
                input.value = 1
            }
            updateCartTotal()
        }

        function addToCartClicked(event) {
            var button = event.target
            var shopItem = button.parentElement.parentElement
            var title = shopItem.getElementsByClassName('shop-item-title')[0].innerText
            var price = shopItem.getElementsByClassName('shop-item-price')[0].innerText
            var imageSrc = shopItem.getElementsByClassName('shop-item-image')[0].src
            addItemToCart(title, price, imageSrc)
            updateCartTotal()
        }

        let button = document.getElementById('add-form')

        button.addEventListener("click", () => {
            let product = document.getElementById('id_form-product')
            $.ajax({
                    url: `http://localhost:8000/sales/get_product/${product.value}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data){
                        addItemToCart(data.id, data.name, data.price, data.image)
                    }
                });
        });

        function addItemToCart(id, title, price, imageSrc) {
            var cartRow = document.createElement('tr')
            // cartRow.classList.add('cart-row')
            var cartItems = document.querySelector('#cart-body')
            var cartItemNames = cartItems.getElementsByClassName('cart-item-title')
            for (var i = 0; i < cartItemNames.length; i++) {
                if (cartItemNames[i].innerText == title) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Ya agregaste ese producto!'
                    })
                    return
                }
            }
            
            
            let total_form = document.querySelector('#id_form-TOTAL_FORMS')

            var cartRowContents = `
                        <td class="cart-item  cart-column">
                            <img class="img-fluid cart-item-image" src="${imageSrc}" width="100" height="100">
                            <input type="hidden" name="form-${total_form.value}-product" class="cart-item-title" id="id_form-${total_form.value}-product" value="${id}"><span class="cart-item-title">${title}</span>
                        </td>
                        <td>
                                <input type="text" name="form-${total_form.value}-price" value="0" readonly class="cart-price" id="id_form-${total_form.value}-price">
                        </td>
                        <td class="cart-quantity cart-column">
                            
                            <input type="number" name="form-${total_form.value}-amount" class="cart-quantity-input" min="1" value="1" id="id_form-${total_form.value}-amount">
                        </td>
                        <td class="cart-column">    
                            <input type="number" name="form-${total_form.value}-total" readonly class="product-total" id="id_form-${total_form.value}-total">
                            <button class="btn btn-danger" type="button">REMOVE</button>
                        </td>`
                        
            cartRow.innerHTML = cartRowContents
            cartRow.querySelector('.cart-price').value = price
            cartRow.querySelector(`#id_form-${total_form.value}-product`).value = id
            cartItems.append(cartRow)
            let amount = cartRow.querySelector(`#id_form-${total_form.value}-amount`)
            cartRow.querySelector(`#id_form-${total_form.value}-total`).value = price * amount.value 
            cartRow.getElementsByClassName('btn-danger')[0].addEventListener('click', removeCartItem)
            cartRow.getElementsByClassName('cart-quantity-input')[0].addEventListener('change', quantityChanged)
            // Add event listener for quantity input
            total_form.value = parseInt(total_form.value) + 1
            updateCartTotal()
        }

        

        function updateCartTotal() {
            var table = document.getElementById("cart-table")
            var total = 0
            var i = 0

            for (let row of table.rows) {

                var priceElement = row[1]
                var quantityElement = row[2]
                var itemTotal = document.getElementById(`id_form-${i}-total`)

                console.log(`precio: ${priceElement.value}`)
                console.log(`cantidad: ${quantityElement.value}`)
                console.log(`total: ${itemTotal.value}`)
                i++
            }


            for (var i = 1; i < x; i++) {
                var cartRow = cartRows[i]
                var priceElement = cartRow.getElementsByClassName('cart-price')[0]
                var quantityElement = cartRow.getElementsByClassName('cart-quantity-input')[0]
                var itemTotal = cartRow.getElementsByClassName(`id_form-${i}-total`)[0]
                console.log(`precio: ${priceElement.value}`)
                console.log(`cantidad: ${quantityElement.value}`)
                console.log(`total: ${itemTotal.value}`)

                var price = parseFloat(priceElement.value)
                itemTotal.value = price * quantityElement.value
                var quantity = quantityElement.value
                total = total + (price * quantity)
            }
            total = Math.round(total * 100) / 100
            document.getElementsByClassName('cart-total-price')[0].value = total
        }
    </script>
{% endblock %}

