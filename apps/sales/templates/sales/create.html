{% extends 'base.html' %} {% load static %} 

{% load crispy_forms_tags %}

{% block title %}
    Ventas
{% endblock %}

{% block css %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'assets/css/sales.css' %}">
{% endblock %}

{% block content %}

    <!-- Inicia cuadro superior de la pantalla (cliente e información extra) -->
    <div class="row">
        <div class="col-md-12">

            <!-- Inicia bloque "Información del cliente" -->
            <div  id="estilo-tabla">
                <div class="col-md-6">
                    <h2 id="titulo-cliente">Información del cliente:</h2>
                    <dl>
                        <dt>Nombre</dt>
                        <dd>{{customer.name}}</dd>
                        <dt>RFC</dt>
                        <dd>{{customer.rfc}}</dd>
                        <dt>Dirección</dt>
                        <dd>{{customer.address}}</dd>
                        <dt>Teléfono</dt>
                        <dd>{{customer.phone}}</dd>
                        <dt>Correo</dt>
                        <dd>{{customer.email}}</dd>
                    </dl>
                </div>
                <!-- Finaliza bloque "Información del cliente" -->

                <!-- Inicia bloque "Otra información" -->
                <div class="col-md-6">            
                    <h2 id="titulo-cliente">Otra información:</h2>
                    
                    <p>Seleccione un método de pago:</p>

                    <div id="radios">
                        <input type="radio" id="efectivo" name="metodo" value="efectivo"
                                checked>
                        <label for="efectivo">Efectivo</label>
                    </div>
                    <div id="radios">
                        <input type="radio" id="tarjeta" name="metodo" value="tarjeta"
                                >
                        <label for="tarjeta">Tarjeta</label>
                    </div>

                    <p>Seleccione tipo de venta:</p>

                    <div id="radios">
                        <input type="radio" id="contado" name="tipo" value="contado"
                                checked>
                        <label for="contado">Contado</label>
                    </div>
                    <div id="radios">
                        <input type="radio" id="credito" name="tipo" value="credito"
                                >
                        <label for="credito">Credito</label>
                    </div>
                </div>
                <!-- Finaliza bloque "Otra información" -->                
            </div>
        </div>
    </div>
    <!-- Finaliza cuadro superior de la pantalla -->

    <br>

    <form method="POST" action="." hx-posts=".">
        {% csrf_token %}
        {% comment %} {{form_details|crispy}} {% endcomment %}


        {{formset.management_form}}
        
        {% if formset %}
            {% for form_details in formset %}
                <div class="card">
                    <div class="card-body">
                        {{form_details|crispy}}
                    </div>
                </div>
            {% endfor %}
            
            
            <div id="empty-form" class="">{{ formset.empty_form }}</div>
        {% endif %}
            
        {{form|crispy}}
        
        <div class="btn-group-justified" role="group" aria-label="...">
            <button id="add-form" type="button" class="btn btn-primary">Agregar producto</button>
            <button class="btn btn-primary" type="submit">Guardar</button>
        </div>

            
    </form>
{% endblock %}

{% block js %}

    <script>
        let form_counter = {{formset|length}};
        console.log(form_counter);

        // For to iterate over the formset
        for (let i = 0; i < form_counter; i++) {
            // get the first form amount
            let amount = document.getElementById('id_form-' + i + '-amount');

            // set onInput function to calculate total on amount
            amount.oninput = function () {
                // get the total
                let total = document.getElementById('id_form-' + i + '-total');

                // get price
                let price = document.getElementById('id_form-' + i + '-price');

                // calculate total
                total.value = price.value * amount.value;

            };
            
            let price = document.getElementById('id_form-' + i + '-price');
            // set onInput function to calculate total on amount
            price.oninput = function () {
                // get the total
                let total = document.getElementById('id_form-' + i + '-total');

                // gget price
//                let amount = document.getElementById('id_form-' + i + '-price');

                // calculate total
                total.value = price.value * amount.value;

            };

            // get product from selectElement
            let product = document.getElementById('id_form-' + i + '-product');
            // add evenLister on change to get the product and set the price
            product.addEventListener('change', function () {
                // get the price
                let price = document.getElementById('id_form-' + i + '-price');
                // get the product
                // Ajax call to get_product/<int:pk>/
                let base_url = "http://localhost:8000/"
                $.ajax({
                    url: `${base_url}sales/get_product/${product.value}/`,
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        // set the price
                        console.log(data);
                        price.value = data.price;
                    }
                });
            });

        }

        const selectElement = document.getElementById('id_product');

        selectElement.addEventListener('change', (event) => {
            price = document.getElementById("id_price");
            price.value = event.target.value;
        });

        cons addMoreBtn = document.getElementById('add-form');




    </script>

{% endblock %}

